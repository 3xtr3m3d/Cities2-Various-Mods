using System;
using cohtml.Net;
using Game;
using Game.SceneFlow;

namespace TrafficLightsEnhancement.UI;

public class UISystem : GameSystemBase
{
    public int[] m_SelectedPattern;
    protected override void OnCreate()
    {
        base.OnCreate();

        m_SelectedPattern = new int[16];

        View view = GameManager.instance.userInterface.view.View;
        view.BindCall("TrafficLightsEnhancementOnPatternChanged", OnPatternChanged);
        view.ExecuteScript("""
            if(!document.querySelector("div.traffic-lights-enhancement-panel")){const n=document.createElement("div");n.innerHTML='\n        <div class="traffic-lights-enhancement-panel">\n            <div class="traffic-lights-enhancement-panel-header">\n                <img class="traffic-lights-enhancement-panel-header-image" src="Media/Game/Icons/TrafficLights.svg" />\n                <div class="traffic-lights-enhancement-panel-header-title">Traffic Lights Enhancement</div>\n            </div>\n            <div class="traffic-lights-enhancement-panel-content">\n                <div class="traffic-lights-enhancement-panel-row">\n                    Three-Way Junction\n                </div>\n                <div class="traffic-lights-enhancement-panel-row" data-ways="3" data-pattern="0">\n                    <div class="traffic-lights-enhancement-panel-radio">\n                        <div class="traffic-lights-enhancement-panel-radio-bullet"></div>\n                    </div>\n                    <span class="traffic-lights-enhancement-panel-secondary-text">Vanilla</span>\n                </div>\n                <div class="traffic-lights-enhancement-panel-row" data-ways="3" data-pattern="2">\n                    <div class="traffic-lights-enhancement-panel-radio">\n                        <div class="traffic-lights-enhancement-panel-radio-bullet"></div>\n                    </div>\n                    <span class="traffic-lights-enhancement-panel-secondary-text">Split Phasing</span>\n                </div>\n                <div class="traffic-lights-enhancement-panel-row-divider"></div>\n                <div class="traffic-lights-enhancement-panel-row">\n                    Four-Way Junction\n                </div>\n                <div class="traffic-lights-enhancement-panel-row" data-ways="4" data-pattern="0">\n                    <div class="traffic-lights-enhancement-panel-radio">\n                        <div class="traffic-lights-enhancement-panel-radio-bullet"></div>\n                    </div>\n                    <span class="traffic-lights-enhancement-panel-secondary-text">Vanilla</span>\n                </div>\n                <div class="traffic-lights-enhancement-panel-row" data-ways="4" data-pattern="2">\n                    <div class="traffic-lights-enhancement-panel-radio">\n                        <div class="traffic-lights-enhancement-panel-radio-bullet"></div>\n                    </div>\n                    <span class="traffic-lights-enhancement-panel-secondary-text">Split Phasing</span>\n                </div>\n                <div class="traffic-lights-enhancement-panel-row" data-ways="4" data-pattern="4">\n                    <div class="traffic-lights-enhancement-panel-radio">\n                        <div class="traffic-lights-enhancement-panel-radio-bullet"></div>\n                    </div>\n                    <span class="traffic-lights-enhancement-panel-secondary-text">Some Weird Mode</span>\n                </div>\n            </div>\n        </div>\n        <style>\n            .traffic-lights-enhancement-panel {\n                width: 300rem;\n                position: absolute;\n                top: calc(10rem+ var(--floatingToggleSize) +6rem);\n                left: 10rem;\n            }\n            .traffic-lights-enhancement-panel-header {\n                border-radius: 4rem 4rem 0rem 0rem;\n                background-color: rgba(24, 33, 51, 0.6);\n                backdrop-filter: blur(5px);\n                color: rgba(75, 195, 241, 1);\n                font-size: 14rem;\n                padding: 6rem 10rem;\n                min-height: 36rem;\n                display: flex;\n                flex-direction: row;\n                align-items: center;\n            }\n            .traffic-lights-enhancement-panel-header-image {\n                width: 24rem;\n                height: 24rem;\n            }\n            .traffic-lights-enhancement-panel-header > .traffic-lights-enhancement-panel-header-title {\n                text-transform: uppercase;\n                flex: 1;\n                text-align: center;\n                overflow-x: hidden;\n                overflow-y: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            .traffic-lights-enhancement-panel-content {\n                border-radius: 0rem 0rem 4rem 4rem;\n                background-color: rgba(42, 55, 83, 0.437500);\n                backdrop-filter: blur(5.000000px);\n                color: rgba(255, 255, 255, 1.000000);\n                flex: 1.000000;\n                position: relative;\n                padding: 6rem;\n            }\n            .traffic-lights-enhancement-panel-row {\n                padding: 3rem 8rem;\n                width: 100%;\n                display: flex;\n            }\n            .traffic-lights-enhancement-panel-row-divider {\n                height: 2px;\n                width: auto;\n                border: 2px solid rgba(255, 255, 255, 0.100000);\n                margin: 6rem -6rem;\n            }\n            .traffic-lights-enhancement-panel-secondary-text {\n                color: rgba(217, 217, 217, 1.000000);\n            }\n            .traffic-lights-enhancement-panel-radio {\n                border: 2px solid rgba(32, 164, 255, 1.000000);\n                margin: 0 10rem 0 0;\n                width: 20.000000rem;\n                height: 20.000000rem;\n                padding: 3px;\n                border-radius: 50.000000%;\n            }\n            .traffic-lights-enhancement-panel-radio-bullet {\n                width: 100.000000%;\n                height: 100.000000%;\n                background-color:  white;\n                opacity: 0.000000;\n                border-radius: 50.000000%;\n                transition-property: opacity;\n                transition-duration: 0.150000s;\n                transition-delay: 0.000000s;\n                transition-timing-function: ease;\n            }\n            .traffic-lights-enhancement-panel-radio-bullet-checked {\n                opacity: 1.000000;\n            }\n        </style>\n    ';document.querySelector("body").appendChild(n);const e=n=>{const e=document.querySelectorAll(".traffic-lights-enhancement-panel-radio-bullet");for(const n of e)n.classList.remove("traffic-lights-enhancement-panel-radio-bullet-checked");const a=JSON.parse(n);console.log(`TrafficLightsEnhancementOnPatternChanged result ${n} m_SelectedPattern ${a}`);for(const n in a){const e=a[n],t=document.querySelector(`.traffic-lights-enhancement-panel-row[data-ways="${n}"][data-pattern="${e}"] .traffic-lights-enhancement-panel-radio-bullet`);t&&t.classList.add("traffic-lights-enhancement-panel-radio-bullet-checked")}};engine.call("TrafficLightsEnhancementOnPatternChanged","3_0").then(e),engine.call("TrafficLightsEnhancementOnPatternChanged","4_0").then(e);const a=n=>{const a=n.currentTarget.dataset,t=document.querySelectorAll(".traffic-lights-enhancement-panel-radio-bullet");for(const n of t)n.classList.remove("traffic-lights-enhancement-panel-radio-bullet-checked");console.log(n.currentTarget,a,a.ways,a.pattern),engine.call("TrafficLightsEnhancementOnPatternChanged",`${a.ways}_${a.pattern}`).then(e)},t=document.querySelectorAll(".traffic-lights-enhancement-panel-row");for(const n of t)n.dataset.ways>0&&(n.onclick=a);const i=document.querySelector("body"),r={attributes:!0,childList:!0,subtree:!0};new MutationObserver(((n,e)=>{const a=document.querySelector("button.selected.item_KJ3.item-hover_WK8.item-active_Spn > img"),t=document.querySelector("div.traffic-lights-enhancement-panel");t&&(t.style.display=a&&"Media/Game/Icons/TrafficLights.svg"==a.src?"block":"none")})).observe(i,r)}
        """);
    }

    protected override void OnUpdate()
    {
    }

    string OnPatternChanged(string input)
    {
        string[] splitInput = input.Split('_');
        if (splitInput.Length == 2) {
            int ways;
            int pattern;
            int.TryParse(splitInput[0], out ways);
            int.TryParse(splitInput[1], out pattern);
            if (ways < m_SelectedPattern.Length)
            {
                m_SelectedPattern[ways] = pattern;
            }
        }
        string result = Newtonsoft.Json.JsonConvert.SerializeObject(m_SelectedPattern);
        Console.WriteLine($"UISystem OnPatternChanged {input} {result}");
        return result;
    }
}